## mako
<%! from django.utils.translation import ugettext as _ %>
<%namespace name='static' file='/static_content.html'/>
<%block name="bodyclass">view-in-course</%block>
<%block name="pagetitle">${_("Retroalimentacion del Estudiante")}</%block>
<%inherit file="/main.html" />
<%block name="headextra">
<%static:css group='style-course'/>
</%block>
<%include file="/courseware/course_navigation.html" args="active_page='eol_feedback'" />

<% from lms.djangoapps.courseware.courses import get_studio_url %>

<style>
    .wrapper-course-material .course-tabs {
        padding: 0px !important;
    }

    #main div {
        border: none;
        display: block;
    }

    #main {
        border: 1px solid #c8c8c8;
    }

    #feedback-general {
        border-radius: 0.4rem;
    }

    #feedback-general .bg-dark {
        border-radius: 0rem 0.4rem 0.4rem 0rem;
    }

    #feedback-general button:hover,
    #feedback-general button:focus,
    #feedback-general button:active {
        background-image: none !important;
        background-color: var(--primary) !important;
        box-shadow: none;
    }

    #main .bg-light {
        background-color:#ededed !important;
    }
    
    div.progress {
        background-color: white;
        width: 200px;
    }
</style>

<%
    is_staff_view = not masquerade or masquerade.role != "student"
%>
<main id="main" aria-label="Content" tabindex="-1">
    <div class="container my-4">
        <h2 class="hd hd-2">Retroalimentación Controles</h2>
        <h3 class="hd hd-3 text-black-50">${course.display_name_with_default_escaped}</h3>
        <!-- General Content -->
        <h2 class="hd hd-2 mt-2 text-center text-primary">Información General</h2>
        <div class="row d-flex bg-light my-2" id="feedback-general">
            <div class="col-6 col-md-4 py-2 my-auto">
                <p class="font-weight-bold text-center mt-2">NOTA</p>
                <p class="font-italic font-weight-light text-center my-0"><small>(Incluye controles y preguntas evaluadas)</small></p>
                <div class="mt-3 text-center">
                    <%
                        if grade_summary['percent'] < grade_cutoff:
                            final_grade = round(10. * (3. / grade_cutoff * grade_summary['percent'] + 1.)) / 10.
                        else:
                            final_grade = round((3. / (1. - grade_cutoff) * grade_summary['percent'] + (7. - (3. / (1. - grade_cutoff)))) * 10.) / 10.
                    %>
                    <h3 class="d-inline bg-white rounded py-2 px-4">${final_grade}</h3>
                </div>
            </div>
              <div class="col-6 col-md-4 py-2 my-auto">
                <p class="font-weight-bold my-2">Escala de Calificación</p>
                <%
                    course_grade_cutoffs_pass = int(grade_cutoff*100)
                %>
                <p class="font-weight-light my-2">${course_grade_cutoffs_pass}% de exigencia</p>
                <p class="font-weight-bold mt-3">Porcentaje de Logro</p>
                <div class="progress my-2">
                    <%
                        student_avg_percent = grade_summary['percent'] * 100
                    %>
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                    aria-valuenow="${student_avg_percent}" aria-valuemin="0" aria-valuemax="100" style="width:${student_avg_percent}%">
                        ${student_avg_percent}%
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4 py-2 bg-dark text-white my-auto">
                <p class="my-3"><span class="font-weight-bold">Promedio del Curso:</span> <span class="font-weight-light"></span> ${avg_grade}</p>
                <p class="my-3"><span class="font-weight-bold">Nota Mínima:</span> <span class="font-weight-light"></span> ${min_grade}</p>
                <p class="my-3"><span class="font-weight-bold">Nota Máxima:</span> <span class="font-weight-light"></span> ${max_grade}</p>
            </div>
        </div>

        <hr class="divider my-4">

        % if not is_staff_view:
            <!-- 'Control' Content -->
            %for section in courseware_summary:
                %for subsection in section['sections']:
                    % if subsection.format and ('Control' in subsection.format):
                        <%
                            if subsection.percent_graded < grade_cutoff:
                                grade = round(10. * (3. / grade_cutoff * subsection.percent_graded + 1.)) / 10.
                            else:
                                grade = round((3. / (1. - grade_cutoff) * subsection.percent_graded + (7. - (3. / (1. - grade_cutoff)))) * 10.) / 10.
                            percent = subsection.percent_graded*100
                        %>
                        <h2 class="hd hd-2 my-2 text-center text-primary">${subsection.format}</h2>
                        <div class="row d-flex bg-light my-2" id="feedback-general">
                            <div class="col-6 col-md-4 py-2 my-auto">
                                <p class="font-weight-bold text-center my-2">NOTA</p>
                                <div class="my-3 text-center">
                                    <h3 class="d-inline bg-white rounded py-2 px-4">${grade}</h3>
                                </div>
                            </div>
                            <div class="col-6 col-md-8 py-2 my-auto">
                                <p class="font-weight-bold mt-3">Porcentaje de Logro</p>
                                <div class="progress my-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                    aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100" style="width:${percent}%">
                                        ${percent}%
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 border-top border-white py-2 my-auto">
                                <div class="row d-flex">
                                    <%
                                        correct_blocks = []
                                        incorrect_blocks = []
                                        for block, score in subsection.problem_scores.items():
                                            block_feedback = get_feedback(block.block_id)
                                            if score.earned == score.possible:
                                                correct_blocks.append(block_feedback)
                                            else:
                                                incorrect_blocks.append(block_feedback)
                                    %>
                                    <div class="col-md-6 py-2">
                                        <p class="text-monospace text-uppercase font-weight-bold text-center my-2"><i class="fas fa-check-circle"></i> Tareas Logradas</p>
                                        <ul>
                                            %for block in correct_blocks:
                                                <li>${block}</li>
                                            %endfor
                                        </ul>
                                    </div>
                                    <div class="col-md-6 py-2">
                                        <p class="text-monospace text-uppercase font-weight-bold text-center my-2"><i class="fas fa-minus-circle"></i> Tareas no Logradas</p>
                                        <ul>
                                            %for block in incorrect_blocks:
                                                <li>${block}</li>
                                            %endfor
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="divider my-4">
                    %endif
                %endfor
            %endfor
        % else:
            <!-- 'Control' Content -->
            %for section in courseware_summary:
                %for subsection in section['sections']:
                    % if subsection.format and ('Control' in subsection.format):
                        <h2 class="hd hd-2 my-2 text-center text-primary">${subsection.format}</h2>
                        <div class="row d-flex bg-light my-2 p-4" id="feedback-general">
                            %for block, score in subsection.problem_scores.items():
                            <div class="col-12">
                                <form method="post" id="form_${block.block_id}">
                                    <div class="form-group">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${csrf_token}"/>
                                        <label for="form_input_${block.block_id}" style="cursor: auto;">
                                            <span class="text-monospace">ID Componente </span>
                                            <span class="font-weight-light">${block.block_id}</span>
                                            <br>
                                            <span class="font-weight-bold">Tarea Asociada</span>
                                        </label>
                                        <% 
                                            block_feedback = get_feedback(block.block_id)
                                        %>
                                        <input type="hidden" name="block_id" value="${block.block_id}" />
                                        <input type="text" name="block_feedback" class="form-control" required id="form_input_${block.block_id}" placeholder="Ingresa la Tarea Matemática asociada al Componente" value="${block_feedback}" />
                                        <span id="form_${block.block_id}_status" class="text-success my-2" style="float:left;"></span>
                                        <button type="submit" id="form_${block.block_id}_submit" class="btn btn-outline-primary btn-sm mt-2" style="float: right;">
                                            <span id="form_${block.block_id}_loading" class="spinner-border spinner-border-sm" style="display: none;" role="status" aria-hidden="true"></span>
                                            Actualizar
                                        </button>
                                    </div>
                                </form>
                            </div>
                            %endfor                            
                        </div>
                        <hr class="divider my-4">
                    %endif
                %endfor
            %endfor
            <script>
                $( document ).ready(function() {
                    $('form').submit(function(e) {
                        var form = $(this);
                        var id = form.attr('id');
                        var url = "${update_url}";
                        data = $('#'+id).serializeArray();
                        params = {
                            "block_id" : data[1].value,
                            "block_feedback" : data[2].value,
                            "course_id" : "${course.id}"
                        }
                        $.ajax({
                            data:  params,
                            url:   url,
                            type:  'post',
                            beforeSend: function () {
                                /*
                                * Set submit button disabled, show loading, and reset input status
                                */
                                $('#'+id+"_submit").prop("disabled", true);
                                $('#'+id+"_loading").show();
                                $('#'+id+"_status").html("")
                            },
                            success:  function (response) {
                                /*
                                * Set input status: correct
                                */
                                $('#'+id+"_status").html("Actualizada Correctamente")
                                console.log(response);
                            },
                            error: function (xhr, ajaxOptions, thrownError) {
                                alert("Error, intente nuevamente más tarde");
                                console.log(xhr);
                                console.log(ajaxOptions);
                                console.log(thrownError);
                            },
                            complete: function() {
                                /*
                                * Set submit button enabled, hide loading
                                */
                                $('#'+id+"_submit").prop("disabled", false);
                                $('#'+id+"_loading").hide();
                            }
                        });
                        e.preventDefault();
                    });
                });
            </script>
        % endif
    </div>
    
</main>